<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Online Admission - St Paul Learning Centre</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">

<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  window.onload = function() {
    emailjs.init("S17h9x6ExMG6mKaQh"); // Your EmailJS Public Key
  }
</script>

<style>
/* Simple spinner CSS animation */
.spinner {
  border: 5px solid #f3f3f3;
  border-top: 5px solid #3498db;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Optional: style message */
#admissionForm p {
  margin-top: 10px;
  font-weight: 600;
}
</style>
</head>
<body>

<!-- Top Navbar -->
<div class="navbar">
  <span class="menu-btn" onclick="openMenu()">&#9776;</span>
  <div class="navbar-center">
    <img src="logo.png" alt="School Logo" class="school-logo">
    <span class="logo-text">St Paul Learning Centre</span>
  </div>
</div>

<!-- Sidebar Menu -->
<nav id="sideMenu" class="side-menu">
  <a href="javascript:void(0)" class="close-btn" onclick="closeMenu()">&times;</a>
  <a href="index.html">News & Announcements</a>
  <a href="student-portal.html">Student Portal</a>
  <a href="admissions.html">Admissions</a>
  <a href="resources.html">Resources</a>
  <a href="showcase.html">Showcase</a>
  <a href="contact.html">Contact</a>
  <a href="timetable.html">Timetable</a>
  <a href="teacher-resources.html">Teacher Resources</a>
  <a href="parent-portal.html">Parent Portal</a>
</nav>

<!-- Main Section -->
<section>
  <h2>Online Admission Form</h2>
  <form class="admission-form" id="admissionForm" enctype="multipart/form-data">
    <input type="text" name="title" placeholder="Title" required>
    <input type="text" name="name" placeholder="Name" required>
    <input type="text" name="time" placeholder="Time" required>
    <input type="text" name="message" placeholder="Message" required>
    <input type="text" name="class" placeholder="Class" required>
    <input type="email" name="email" placeholder="Email" required>
    <input type="file" name="photo" accept="image/*" required>
    <button type="submit" class="submit-btn">Send</button>
    <p id="formMessage"></p>
    <div id="spinner" style="display:none; text-align:center; margin-top:10px;">
      <div class="spinner"></div>
      <p>Submitting your application...</p>
    </div>
  </form>
</section>

<footer>
  &copy; 2025 St Paul Learning Centre. All rights reserved.
</footer>

<script>
function openMenu() {
  document.getElementById("sideMenu").style.width = "280px";
}

function closeMenu() {
  document.getElementById("sideMenu").style.width = "0";
}

// Form Submission with EmailJS + Google Sheets
document.getElementById('admissionForm').addEventListener('submit', function(event){
    event.preventDefault();
    const form = event.target;
    const messageEl = document.getElementById('formMessage');
    const spinner = document.getElementById('spinner');

    spinner.style.display = "block";
    messageEl.innerText = "";

    let emailSuccess = false;
    let sheetSuccess = false;

    const photoFile = form.photo.files[0];
    const formData = new FormData(form);

    if(photoFile){
        const reader = new FileReader();
        reader.onload = function(){
            const base64String = reader.result.split(',')[1]; // Remove "data:image/...;base64,"
            
            // Send EmailJS with attachment
            emailjs.send('service_ndh30l8', 'template_0k9iqza', {
                title: form.title.value,
                name: form.name.value,
                time: form.time.value,
                message: form.message.value,
                class: form.class.value,
                email: form.email.value,
                attachment: base64String,
                attachment_filename: photoFile.name
            }).then(function(response){
                console.log('EmailJS SUCCESS!', response.status, response.text);
                emailSuccess = true;
                checkBothSuccess();
            }, function(error){
                console.log('EmailJS FAILED...', error);
                spinner.style.display = "none";
                messageEl.innerText = "Oops! Something went wrong with email submission.";
                messageEl.style.color = "red";
            });
        };
        reader.readAsDataURL(photoFile);
    } else {
        // Send email normally if no photo
        emailjs.sendForm('service_ndh30l8', 'template_0k9iqza', form)
        .then(function(response){
            console.log('EmailJS SUCCESS!', response.status, response.text);
            emailSuccess = true;
            checkBothSuccess();
        }, function(error){
            console.log('EmailJS FAILED...', error);
            spinner.style.display = "none";
            messageEl.innerText = "Oops! Something went wrong with email submission.";
            messageEl.style.color = "red";
        });
    }

    // Google Sheets submission
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzYb0eivp134ubrqkhoB7hQPPtVyM-M/exec';
    fetch(scriptURL, { method: 'POST', body: formData })
    .then(response => {
        console.log('Google Sheets SUCCESS', response);
        sheetSuccess = true;
        checkBothSuccess();
    })
    .catch(error => {
        console.error('Google Sheets ERROR', error);
        spinner.style.display = "none";
        messageEl.innerText = "Oops! Something went wrong with Google Sheets submission.";
        messageEl.style.color = "red";
    });

    function checkBothSuccess() {
        if(emailSuccess && sheetSuccess){
            spinner.style.display = "none";
            messageEl.innerText = "Application submitted successfully!";
            messageEl.style.color = "green";
            form.reset();
        }
    }
});
</script>

</body>
</html>
