<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Super Explaining Calculator — Nicholas</title>
  <style>
    :root{
      --bg-dark: #0b1220;
      --panel-dark: #0f1724;
      --accent: #0ea5a4;
      --muted: #94a3b8;
      --glass: rgba(255,255,255,0.04);
      --realistic-bg: #cbd5e1;
      --realistic-key: #e6eef7;
      --realistic-accent: #1f2937;
      --digital-glow: 0 6px 20px rgba(14,165,164,0.14);
      --rounded: 10px;
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    }

    /* Reset + base */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:28px;
      background: linear-gradient(180deg,#071126 0%, #0b2540 100%);
      color:#e6eef7;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .app {
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:20px;
      align-items:start;
    }

    /* Controls panel */
    .controls {
      background:var(--panel-dark);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--digital-glow);
    }

    .controls h1{
      margin:6px 0 12px;
      font-size:20px;
      letter-spacing:0.2px;
    }

    .switch-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }

    .switch-btn{
      padding:8px 12px;
      border-radius:12px;
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      color:var(--muted);
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .switch-btn.active{
      background:linear-gradient(90deg,var(--accent),#06b6d4);
      border: none;
      color:#041022;
      box-shadow: 0 6px 20px rgba(6,182,212,0.15);
    }

    /* Calculator container (both modes share this) */
    .calc-wrap{
      display:flex;
      gap:20px;
    }

    .calculator{
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border-radius:18px;
      padding:14px;
      width:420px;
      box-shadow:var(--digital-glow);
    }

    /* Realistic mode style (simulates physical device) */
    .calculator.realistic{
      background: linear-gradient(180deg, #dbeafe, #c7d2fe);
      color:#0b1220;
      padding:18px;
      border-radius:18px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.25);
    }
    .calculator.realistic .display{
      background: #0b1220;
      color:#dbeafe;
      border-radius:8px;
    }
    .calculator.realistic button.key{
      background:var(--realistic-key);
      color:var(--realistic-accent);
      box-shadow: inset 0 -4px 0 rgba(0,0,0,0.06);
    }
    .calculator.realistic button.fn{ background:#fbbf24; color:#08111a }
    .calculator.realistic button.equal{ background:#06b6d4; color:#041022; }

    /* Digital mode style (glowing) */
    .calculator.digital{
      background: linear-gradient(180deg,#071226,#0b1730);
      color:#e6eef7;
    }
    .calculator.digital .display{
      background: linear-gradient(180deg,#001018,#001826);
      color:#00ffb3;
      box-shadow: 0 6px 20px rgba(0,255,179,0.06) inset;
    }
    .calculator.digital button.key{
      background:#0f1724;
      color:#e6eef7;
      box-shadow: 0 6px 18px rgba(2,6,23,0.45);
    }
    .calculator.digital button.fn{ background: #334155; color:#e6eef7; }
    .calculator.digital button.equal{ background: linear-gradient(90deg,#06b6d4,#0ea5a4); color:#001522; box-shadow: 0 12px 30px rgba(14,165,164,0.18); }

    /* Display */
    .display{
      height:78px;
      border-radius:12px;
      padding:10px 12px;
      font-size:20px;
      text-align:right;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
      overflow:hidden;
      white-space:nowrap;
    }
    .expr{ font-size:14px; opacity:0.9; color:var(--muted); }
    .val{ font-size:22px; font-weight:700; }

    /* Keys grid */
    .keys{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:8px;
    }
    button{
      padding:12px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      transition:transform .08s ease, box-shadow .12s ease;
    }
    button:active{ transform:translateY(2px) scale(0.995) }

    .wide{ grid-column: span 2; }
    .equal{ grid-row: span 2; display:flex; align-items:center; justify-content:center; }

    .small{ padding:8px; font-size:13px; }

    /* Right column: history + explanation */
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:16px;
      padding:14px;
      min-height:420px;
      box-shadow:var(--digital-glow);
      color:var(--muted);
    }
    .panel h3{ margin:4px 0 8px; color:#e6eef7 }
    .history{
      max-height:320px; overflow:auto; padding:8px; border-radius:8px;
      background: rgba(255,255,255,0.02);
    }
    .hist-item{
      padding:8px; border-radius:8px; margin-bottom:8px; background: rgba(255,255,255,0.01);
      display:flex; justify-content:space-between; gap:8px; color:var(--muted);
    }
    .explain{
      margin-top:12px; font-size:15px; color:#dbeafe;
    }

    /* Footer small */
    .meta{ font-size:13px; opacity:0.75; color:var(--muted); margin-top:12px }

    /* Light theme adjustments */
    .light body, .light .panel, .light .calculator.digital { }
    .light-mode{
      background: linear-gradient(180deg,#f8fafc,#eef2ff);
      color:#0b1220;
    }

    /* Responsive */
    @media (max-width:900px){
      .app{ grid-template-columns: 1fr; max-width:520px }
      .calculator{ width:100% }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Left column: controls + calc -->
    <div>
      <div class="controls">
        <h1 id="main-title">🧮 Super Explaining Calculator</h1>

        <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
          <button id="langBtn" class="switch-btn" title="Language toggle">EN 🇬🇧</button>
          <button id="designBtn" class="switch-btn active" title="Design: Realistic / Digital">Realistic</button>
          <button id="themeBtn" class="switch-btn" title="Theme: Light / Dark">Dark</button>
        </div>

        <div class="calc-wrap" style="margin-top:6px;">
          <!-- Calculator -->
          <div id="calc" class="calculator realistic" role="application" aria-label="Calculator">
            <div id="display" class="display" aria-live="polite">
              <div class="expr" id="exprLine">&nbsp;</div>
              <div class="val" id="valueLine">0</div>
            </div>

            <div class="keys" id="keys">
              <!-- Row1 -->
              <button class="small key fn" data-action="mc">MC</button>
              <button class="small key fn" data-action="mr">MR</button>
              <button class="small key fn" data-action="mplus">M+</button>
              <button class="small key fn" data-action="mminus">M-</button>
              <button class="small key" data-insert="(">(</button>

              <!-- Row2 -->
              <button class="key" data-insert="7">7</button>
              <button class="key" data-insert="8">8</button>
              <button class="key" data-insert="9">9</button>
              <button class="key" data-insert="/" title="divide">÷</button>
              <button class="key fn" data-insert="Math.sqrt(" title="square root">√</button>

              <!-- Row3 -->
              <button class="key" data-insert="4">4</button>
              <button class="key" data-insert="5">5</button>
              <button class="key" data-insert="6">6</button>
              <button class="key" data-insert="*" title="multiply">×</button>
              <button class="key fn" data-insert="**" title="power">^</button>

              <!-- Row4 -->
              <button class="key" data-insert="1">1</button>
              <button class="key" data-insert="2">2</button>
              <button class="key" data-insert="3">3</button>
              <button class="key" data-insert="-" title="subtract">−</button>
              <button class="key fn" data-insert="Math.pow(" title="xⁿ">xʸ</button>

              <!-- Row5 -->
              <button class="key wide" data-insert="0">0</button>
              <button class="key" data-insert=".">.</button>
              <button class="key" data-insert="+" title="add">+</button>
              <button class="key fn" data-insert="Math.sin(" title="sine">sin</button>
              <button class="key equal" id="equalBtn" title="equals">=</button>

              <!-- Row6 -->
              <button class="key fn" data-insert="Math.cos(">cos</button>
              <button class="key fn" data-insert="Math.tan(">tan</button>
              <button class="key fn" data-insert="Math.log10(">log</button>
              <button class="key fn" data-insert="Math.log(">ln</button>
              <button class="key fn" data-insert="Math.PI">π</button>

              <!-- Row7 -->
              <button class="key fn" data-insert="Math.E">e</button>
              <button class="key fn" data-action="sq">x²</button>
              <button class="key fn" data-action="cube">x³</button>
              <button class="key fn" data-action="percent">%</button>
              <button class="key" data-action="clear">AC</button>

              <!-- Row8 -->
              <button class="key" data-action="del">DEL</button>
              <button class="key" data-action="ans">ANS</button>
              <button class="key" data-action="history">HIST</button>
              <button class="key" data-action="explain">Explain</button>
              <button class="key" data-action="neg">+/-</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right column: history + explanation -->
    <div class="panel" id="panel">
      <h3 id="hist-title">History</h3>
      <div class="history" id="historyList" role="log" aria-live="polite"></div>

      <div class="explain" id="explainText">
        <strong id="resLabel">Result:</strong>
        <div id="resExplain" style="margin-top:6px; color:#cfeff0">No calculation yet.</div>
      </div>

      <div class="meta" id="metaText">Memory: 0   •   Mode: Realistic   •   Language: English</div>
    </div>
  </div>

<script>
/* ===========================
   State & Translations
   =========================== */
const translations = {
  en: {
    mainTitle: "🧮 Super Explaining Calculator",
    history: "History",
    resultLabel: "Result:",
    noCalc: "No calculation yet.",
    memLabel: "Memory:",
    modeReal: "Realistic",
    modeDig: "Digital",
    themeDark: "Dark",
    themeLight: "Light",
    langShort: "EN 🇬🇧",
    langSpeakPrefix: "Result",
    explainBtn: "Explain",
    histBtn: "History",
    ans: "ANS",
  },
  lg: {
    mainTitle: "🧮 Kalikulata ey'Obukugu n'Okunnyonnyola",
    history: "Ebyabaddibwa",
    resultLabel: "Ekyavaamu:",
    noCalc: "Tewali kunonyebwa.",
    memLabel: "Obubonero:",
    modeReal: "Realistic",
    modeDig: "Digital",
    themeDark: "Ddwaniro",
    themeLight: "Enkazi",
    langShort: "LG 🇺🇬",
    langSpeakPrefix: "Obubonero",
    explainBtn: "Tunnyonnyole",
    histBtn: "Ebyabaddibwa",
    ans: "ANS",
  }
};

let lang = 'en';
let design = 'realistic'; // realistic | digital
let theme = 'dark'; // dark | light

let expr = '';           // expression string for evaluation
let lastAns = 0;         // ANS value
let memory = 0;          // stored memory
let history = [];        // array of {expr, result, explanation}
const displayExpr = document.getElementById('exprLine');
const displayVal = document.getElementById('valueLine');
const historyList = document.getElementById('historyList');
const explainDiv = document.getElementById('resExplain');
const resLabel = document.getElementById('resLabel');
const metaText = document.getElementById('metaText');
const mainTitle = document.getElementById('main-title');

/* ===========================
   Helpers
   =========================== */
function setLang(newLang){
  lang = newLang;
  document.getElementById('langBtn').innerText = translations[lang].langShort;
  document.getElementById('hist-title').innerText = translations[lang].history;
  resLabel.innerText = translations[lang].resultLabel;
  explainDiv.innerText = translations[lang].noCalc;
  mainTitle.innerText = translations[lang].mainTitle;
  updateMeta();
}

function setDesign(newDesign){
  design = newDesign;
  const calc = document.getElementById('calc');
  if(design === 'realistic'){
    calc.classList.remove('digital');
    calc.classList.add('realistic');
    document.getElementById('designBtn').classList.add('active');
    document.getElementById('designBtn').innerText = translations[lang].modeReal;
  } else {
    calc.classList.remove('realistic');
    calc.classList.add('digital');
    document.getElementById('designBtn').classList.remove('active');
    document.getElementById('designBtn').innerText = translations[lang].modeDig;
  }
  updateMeta();
}

function setTheme(newTheme){
  theme = newTheme;
  if(theme === 'light'){
    document.body.style.background = "linear-gradient(180deg,#f8fafc,#eef2ff)";
    document.body.style.color = "#04203a";
    document.getElementById('themeBtn').classList.add('active');
    document.getElementById('themeBtn').innerText = translations[lang].themeLight;
  } else {
    document.body.style.background = "linear-gradient(180deg,#071126,#0b2540)";
    document.body.style.color = "#e6eef7";
    document.getElementById('themeBtn').classList.remove('active');
    document.getElementById('themeBtn').innerText = translations[lang].themeDark;
  }
  updateMeta();
}

function updateMeta(){
  metaText.innerText = `${translations[lang].memLabel} ${memory} • Mode: ${design === 'realistic' ? translations[lang].modeReal : translations[lang].modeDig} • Language: ${lang === 'en' ? 'English' : 'Luganda'}`;
}

/* ===========================
   Input / Key handling
   =========================== */
function refreshDisplay(){
  displayExpr.innerText = expr || '\u00A0';
  displayVal.innerText = expr ? expr : '0';
}

function insertText(token){
  // allowed insertion tokens include numbers, ., Math.* calls, operators, parentheses, ANS token replacement
  expr += token;
  refreshDisplay();
}

function setValueDirect(value){
  expr = String(value);
  refreshDisplay();
}

function clearAll(){
  expr = '';
  refreshDisplay();
  explainDiv.innerText = translations[lang].noCalc;
}

function deleteChar(){
  expr = expr.slice(0,-1);
  refreshDisplay();
}

function negateValue(){
  // try to wrap the last number into ( -number )
  if(!expr) return;
  // simple heuristic: if expr ends with digits, toggle sign
  // For simplicity, append "*-1" if last token
  expr = `(${expr})*-1`;
  refreshDisplay();
}

/* ===========================
   Memory operations
   =========================== */
function memoryClear(){ memory = 0; updateMeta(); speakShort(`${translations[lang].memLabel} ${memory}`); }
function memoryRecall(){ setValueDirect(memory); speakShort(`${translations[lang].memLabel} ${memory}`); }
function memoryPlus(){ 
  try {
    const val = evaluateExpression(expr);
    memory += Number(val) || 0; updateMeta(); speakShort(`${translations[lang].memLabel} ${memory}`);
  } catch(e){ speakShort(errorSpeak('calcError')); }
}
function memoryMinus(){ 
  try {
    const val = evaluateExpression(expr);
    memory -= Number(val) || 0; updateMeta(); speakShort(`${translations[lang].memLabel} ${memory}`);
  } catch(e){ speakShort(errorSpeak('calcError')); }
}

/* ===========================
   Evaluation
   =========================== */
function safeExpressionForEval(input){
  // Replace common tokens to Math.* equivalents and safe operators
  // Allow ANS token to be replaced with lastAns
  let s = String(input);
  s = s.replace(/\^/g, '**');

  // Replace unicode division/multiplication signs if present
  s = s.replace(/÷/g, '/').replace(/×/g, '*').replace(/−/g,'-');

  // Replace 'ANS' with lastAns
  s = s.replace(/\bANS\b/gi, `(${lastAns})`);

  // Protect: Only allow characters and words we expect (digits, operators, Math., parentheses)
  // We will still execute via Function but we control the replacements.
  return s;
}

function evaluateExpression(input){
  if(!input) return 0;
  const safe = safeExpressionForEval(input);

  // Limit potentially dangerous access: we create a Function with Math in scope only
  // Build a function that returns the expression using Math and Number only
  // We allow Math.* functions because we will use them via the transformed string
  const fnBody = `"use strict"; return (${safe});`;
  const fn = new Function('Math','Number', fnBody);
  const result = fn(Math,Number);
  if(typeof result === 'number' && !isFinite(result)) throw new Error('Non-finite result');
  return result;
}

/* ===========================
   Explanations & Speech
   =========================== */
function buildExplanation(exprText, res){
  // produce a short explanation in the chosen language
  if(!exprText) return translations[lang].noCalc;
  if(lang === 'en'){
    return `The expression ${exprText} equals ${res}.`;
  } else {
    return `Ensonda ${exprText} eweereza ku ${res}.`;
  }
}

function speakShort(text){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang === 'en' ? 'en-GB' : 'en-UG';
  u.rate = 1;
  u.pitch = 1;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

/* ===========================
   History management
   =========================== */
function pushHistory(exprText, result, explanation){
  const entry = {expr: exprText, result, explanation, ts: Date.now()};
  history.unshift(entry);
  if(history.length>50) history.pop();
  renderHistory();
}

function renderHistory(){
  historyList.innerHTML = '';
  if(history.length===0){
    const empty = document.createElement('div'); empty.innerText = translations[lang].noCalc; empty.style.opacity = 0.7;
    historyList.appendChild(empty); return;
  }
  history.forEach(h=>{
    const el = document.createElement('div');
    el.className = 'hist-item';
    el.innerHTML = `<div style="flex:1;min-width:0"><div style="font-weight:700;color:#e6eef7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${h.expr}</div><div style="font-size:13px;color:var(--muted)">${h.explanation}</div></div><div style="margin-left:10px;color:#a7f0ea;font-weight:800">${h.result}</div>`;
    el.onclick = ()=>{ setValueDirect(h.result); explainDiv.innerText = h.explanation; speakShort(`${translations[lang].resultLabel} ${h.result}. ${h.explanation}`); };
    historyList.appendChild(el);
  });
}

/* ===========================
   High-level calculate function
   =========================== */
function calculateNow(){
  try {
    const exprToEval = expr || String(lastAns || 0);
    const result = evaluateExpression(exprToEval);
    lastAns = result;
    const explanation = buildExplanation(exprToEval, result);
    displayVal.innerText = result;
    displayExpr.innerText = exprToEval;
    explainDiv.innerText = explanation;
    pushHistory(exprToEval, result, explanation);
    speakShort(`${translations[lang].resultLabel} ${result}. ${explanation}`);
    expr = String(result); // set result for next operations
  } catch(err){
    displayVal.innerText = 'Error';
    explainDiv.innerText = lang === 'en' ? 'Invalid expression. Check input.' : 'Ensonda tewaliiyo. Laba byowandisizza.';
    speakShort(lang === 'en' ? 'Error. Invalid expression.' : 'Ensobi. Ensonda tewaliiyo.');
  }
  updateMeta();
}

/* ===========================
   Hook up UI events
   =========================== */
document.getElementById('langBtn').addEventListener('click', ()=>{
  setLang(lang === 'en' ? 'lg' : 'en');
});

document.getElementById('designBtn').addEventListener('click', ()=>{
  setDesign(design === 'realistic' ? 'digital' : 'realistic');
});

document.getElementById('themeBtn').addEventListener('click', ()=>{
  setTheme(theme === 'dark' ? 'light' : 'dark');
});

document.getElementById('keys').addEventListener('click', (ev)=>{
  const btn = ev.target.closest('button');
  if(!btn) return;
  const ins = btn.dataset.insert;
  const action = btn.dataset.action;

  if(ins !== undefined){
    // Insert token (numbers, Math.*, etc)
    insertText(ins);
    return;
  }

  switch(action){
    case 'clear': clearAll(); break;
    case 'del': deleteChar(); break;
    case 'mc': memoryClear(); break;
    case 'mr': memoryRecall(); break;
    case 'mplus': memoryPlus(); break;
    case 'mminus': memoryMinus(); break;
    case 'sq': insertText('**2'); break;
    case 'cube': insertText('**3'); break;
    case 'percent': insertText('/100'); break;
    case 'ans': setValueDirect(lastAns); break;
    case 'history': renderHistory(); break;
    case 'explain': {
      try {
        const res = evaluateExpression(expr || String(lastAns));
        const expl = buildExplanation(expr || String(lastAns), res);
        explainDiv.innerText = expl;
        speakShort(expl);
      } catch(e){
        explainDiv.innerText = lang === 'en' ? 'Cannot explain invalid expression.' : "Tosobola okunnyonnyola ensobi.";
        speakShort(lang === 'en' ? 'Cannot explain invalid expression.' : "Tosobola okunnyonnyola ensobi.");
      }
    } break;
    case 'neg': negateValue(); break;
    default: break;
  }
});

/* Equal button */
document.getElementById('equalBtn').addEventListener('click', calculateNow);

/* Keyboard support (basic) */
window.addEventListener('keydown', (e)=>{
  if(e.key >= '0' && e.key <= '9'){ insertText(e.key); return; }
  if(e.key === '.') { insertText('.'); return; }
  if(e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/' ) { insertText(e.key); return; }
  if(e.key === 'Enter'){ e.preventDefault(); calculateNow(); return; }
  if(e.key === 'Backspace'){ deleteChar(); return; }
});

/* ===========================
   Initialization
   =========================== */
setLang('en');
setDesign('realistic');
setTheme('dark');
refreshDisplay();
renderHistory();
updateMeta();

/* ===========================
   Utility: error speech message
   =========================== */
function errorSpeak(key){
  if(key === 'calcError') return lang==='en' ? 'Calculation error' : 'Ensobi mu kubala';
  return '';
}

/* Accessibility: announce initial state
   (small delay so screen readers pick it)
*/
setTimeout(()=>{ speakShort(translations[lang].mainTitle); }, 600);

</script>
</body>
</html>
