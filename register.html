<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Registration - St Paul Learning Centre</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth, 
  createUserWithEmailAndPassword, 
  signInWithPopup, 
  GoogleAuthProvider,
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBvLXOx9N88hBBLMHVCcEM3zBK-AYfQI_o",
  authDomain: "my-school-st-paul-1455a.firebaseapp.com",
  projectId: "my-school-st-paul-1455a",
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// Redirect if already logged in
onAuthStateChanged(auth, user => {
  if(user) window.location.href = "student-dashboard.html";
});

// Email/password registration
window.registerStudent = async function(event) {
  event.preventDefault();
  const fullname = document.getElementById("fullname").value;
  const email = document.getElementById("email").value;
  const grade = document.getElementById("grade").value;
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  const messageBox = document.getElementById("message");

  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const uid = userCredential.user.uid;

    await setDoc(doc(db, "students", uid), {
      fullname,
      email,
      grade,
      username,
      registeredAt: new Date().toISOString()
    });

    messageBox.style.color = "green";
    messageBox.textContent = `üéâ Registration successful, ${fullname}! Redirecting...`;

    setTimeout(() => window.location.href = "student-dashboard.html", 2000);

  } catch(error) {
    messageBox.style.color = "red";
    messageBox.textContent = "‚ùå Error: " + error.message;
  }
};

// Google Sign-In
window.registerWithGoogle = async function() {
  const messageBox = document.getElementById("message");
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;

    // Save to Firestore if new
    await setDoc(doc(db, "students", user.uid), {
      fullname: user.displayName || "Google User",
      email: user.email,
      grade: "N/A",
      username: user.displayName || user.email,
      registeredAt: new Date().toISOString()
    }, { merge: true });

    messageBox.style.color = "green";
    messageBox.textContent = `üéâ Welcome ${user.displayName || "Student"}! Redirecting...`;

    setTimeout(() => window.location.href = "student-dashboard.html", 2000);

  } catch(error) {
    messageBox.style.color = "red";
    messageBox.textContent = "‚ùå Error: " + error.message;
  }
};
</script>
</head>
<body>
<header>
  <h1>St Paul Learning Centre</h1>
  <div class="motto">Strive For Success</div>
  <p>Empowering students, connecting families, supporting teachers.</p>
</header>

nav id="sideMenu" class="side-menu">
      <a href="javascript:void(0)" class="close-btn" onclick="closeMenu()">&times;</a>
      <a href="index.html">News & Announcements</a>
      <a href="student-portal.html">Student Portal</a>
      <a href="admissions.html">Admissions</a>
      <a href="resources.html">Resources</a>
      <a href="showcase.html">Showcase</a>
      <a href="contact.html">Contact</a>
      <a href="timetable.html">Timetable</a>
      <a href="teacher-resources.html">Teacher Resources</a>
      <a href="parent-portal.html">Parent Portal</a>
  </nav>
<section>
  <h2>üìù Student Registration</h2>
  <form onsubmit="registerStudent(event)">
    <label for="fullname">Full Name:</label>
    <input type="text" id="fullname" required>

    <label for="email">Email Address:</label>
    <input type="email" id="email" required>

    <label for="grade">Grade:</label>
    <select id="grade" required>
      <option value="">Select Grade</option>
      <option value="8">Grade 8</option>
      <option value="9">Grade 9</option>
      <option value="10">Grade 10</option>
    </select>

    <label for="username">Choose a Username:</label>
    <input type="text" id="username" required>

    <label for="password">Create Password:</label>
    <input type="password" id="password" required>

    <button type="submit">Register</button>
  </form>

  <button onclick="registerWithGoogle()" style="margin-top:10px;">Sign up / Login with Google</button>

  <p id="message" style="font-weight:bold; margin-top:10px;"></p>
  <p>Already registered? <a href="student-dashboard.html">Go to Dashboard</a>.</p>
</section>

<footer>
  &copy; 2025 St Paul Learning Centre. All rights reserved.
</footer>
</body>
</html>
